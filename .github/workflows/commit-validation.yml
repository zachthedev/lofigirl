name: Commit Validation

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-commits:
    runs-on: ubuntu-24.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: npm
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Validate commit messages
        run: |
          # Get commit range for this PR
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "üîç Validating commits from $BASE_SHA to $HEAD_SHA"
          
          # Skip validation if no commits to check
          if ! git log --oneline "$BASE_SHA..$HEAD_SHA" | head -1; then
            echo "‚úÖ No commits to validate"
            exit 0
          fi
          
          FAILED_COMMITS=""
          
          # Check each commit with commitlint
          while IFS='|' read -r commit_hash commit_message; do
            if [ -n "$commit_hash" ] && [ -n "$commit_message" ]; then
              echo "Checking: $commit_message"
              
              if ! echo "$commit_message" | npx commitlint --config ./commitlint.config.js --quiet; then
                echo "‚ùå Invalid: $commit_message"
                FAILED_COMMITS="${FAILED_COMMITS}‚Ä¢ $commit_message\n"
              else
                echo "‚úÖ Valid: $commit_message"
              fi
            fi
          done < <(git log --format="%H|%s" --reverse "$BASE_SHA..$HEAD_SHA")
          
          # If any commits failed, provide helpful guidance and fail
          if [ -n "$FAILED_COMMITS" ]; then
            echo ""
            echo "‚ùå COMMIT VALIDATION FAILED"
            echo ""
            echo "The following commits don't follow Conventional Commits format:"
            echo -e "$FAILED_COMMITS"
            echo ""
            echo "üí° Fix with these commit types:"
            echo "  ‚Ä¢ feat: New feature or functionality"
            echo "  ‚Ä¢ fix: Bug fixes"
            echo "  ‚Ä¢ docs: Documentation updates"
            echo "  ‚Ä¢ chore: Maintenance, dependencies, tooling"
            echo "  ‚Ä¢ refactor: Code changes (no functional changes)"
            echo "  ‚Ä¢ style: Formatting (no functional changes)"
            echo "  ‚Ä¢ test: Add or update tests"
            echo "  ‚Ä¢ ci: CI/CD pipeline changes"
            echo ""
            echo "üîß How to fix: Use 'Squash and merge' with proper commit message"
            exit 1
          fi
          
          echo "‚úÖ All commits follow Conventional Commits format!"
      
      - name: Create PR comment for failed validation
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚ùå Commit Validation Failed - Some commits don't follow Conventional Commits format. Use 'Squash and merge' when merging this PR with a proper commit message like 'feat: description' or 'fix: description'."